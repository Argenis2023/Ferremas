{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Carrito de compras | Ferremas</title>
    <link rel="stylesheet" href="{% static 'store/styles.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <h1>Carrito de compras</h1>
        <a href="{% url 'store_home' %}"><i class="fa-solid fa-arrow-left"></i> Volver a la tienda</a>
    </header>
    <main>
        <h2>Tu carrito</h2>
        <div id="cart-list" class="store-grid"></div>
        <div id="cart-summary"></div>
    </main>
    <script>
    // ----------- FUNCIONES DEL CARRITO -----------
    // Obtener carrito de localStorage
    function getCart() {
        let cart = localStorage.getItem('ferremas_cart');
        return cart ? JSON.parse(cart) : [];
    }

    // Guardar carrito
    function saveCart(cart) {
        localStorage.setItem('ferremas_cart', JSON.stringify(cart));
    }

    // Quitar producto del carrito
    function removeFromCart(code) {
        let cart = getCart();
        cart = cart.filter(item => item.code !== code);
        saveCart(cart);
        renderCart();
    }

    // Cambiar cantidad de producto
    function changeQty(code, qty) {
        let cart = getCart();
        cart = cart.map(item => item.code === code ? { ...item, quantity: qty } : item);
        saveCart(cart);
        renderCart();
    }

    // Renderizar carrito
    function renderCart() {
        let cart = getCart();
        const list = document.getElementById('cart-list');
        const summary = document.getElementById('cart-summary');

        if (cart.length === 0) {
            list.innerHTML = "<p style='text-align:center'>No hay productos en el carrito.</p>";
            summary.innerHTML = "";
            return;
        }

        let total = 0;
        list.innerHTML = cart.map(p => {
            let subtotal = (parseFloat(p.price) * p.quantity) || 0;
            total += subtotal;
            return `
                <div class="store-product-card">
                    <div class="product-main">
                        <h3>${p.name}</h3>
                        <div class="product-meta">
                            <span><i class="fa-solid fa-barcode"></i> ${p.code}</span>
                            <span><i class="fa-solid fa-tag"></i> ${p.brand}</span>
                            ${p.category ? `<div class="prod-cat"><i class="fa-solid fa-tags"></i> ${p.category}</div>` : ""}
                        </div>
                    </div>
                    <div class="product-price-stock">
                        <div class="prod-price"><i class="fa-solid fa-dollar-sign"></i> ${p.price}</div>
                        <label>
                            <span>Cantidad: </span>
                            <input type="number" min="1" max="${p.max_stock}" value="${p.quantity}" style="width:50px" onchange="changeQty('${p.code}', this.value)">
                            <span style="color:#888;font-size:0.9em;">(Stock: ${p.max_stock})</span>
                        </label>
                        <div class="prod-subtotal">Subtotal: $${subtotal.toFixed(2)}</div>
                        <button class="btn danger" onclick="removeFromCart('${p.code}')"><i class="fa-solid fa-trash"></i> Quitar</button>
                    </div>
                </div>
            `;
        }).join('');
        summary.innerHTML = `<div style="text-align:right; margin-top:20px;">
            <strong>Total: $${total.toFixed(2)}</strong>
            <button class="btn primary" onclick="checkout()"><i class="fa-solid fa-credit-card"></i> Pagar con WebPay</button>
        </div>`;
    }

    // Simular checkout
    function checkout() {
        alert('En el próximo paso integrarás WebPay.\nPor ahora, este botón solo simula el pago.');
    }

    // Inicializar
    renderCart();

    // Hacer disponibles las funciones al window para los botones
    window.removeFromCart = removeFromCart;
    window.changeQty = changeQty;
    window.checkout = checkout;
    </script>
</body>
</html>
