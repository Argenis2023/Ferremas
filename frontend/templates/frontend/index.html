<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Inventario de Productos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 24px;
            background: #f7f7f7;
        }
        h1, h2 {
            color: #222;
        }
        .logout-link {
            float: right;
            margin-top: 10px;
        }
        #product-list div, #movement-list div {
            background: #fff;
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        form {
            margin-top: 18px;
            margin-bottom: 30px;
            padding: 15px 20px;
            background: #fff;
            border-radius: 8px;
            max-width: 440px;
            border: 1px solid #e3e3e3;
        }
        label {
            display: block;
            margin-bottom: 7px;
        }
        input[type="text"], input[type="number"], select {
            width: 96%;
            padding: 7px;
            margin-bottom: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        button {
            background: #1976d2;
            color: #fff;
            padding: 7px 18px;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 7px;
            margin-bottom: 7px;
            margin-right: 4px;
        }
        button:hover {
            background: #1565c0;
        }
        #cancel-btn {
            background: #b71c1c;
        }
        #cancel-btn:hover {
            background: #800000;
        }
        @media (max-width: 600px) {
            form, #product-list div, #movement-list div {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    {% if user.is_authenticated %}
        <div class="logout-link">
            <a href="{% url 'logout' %}" style="color: #1976d2; font-weight: bold; text-decoration: none;">
                Cerrar sesión
            </a>
        </div>
    {% endif %}
    <h1>Inventario de Productos</h1>

    <div id="product-list"></div>

    <h2>Agregar / Editar Producto</h2>
    <form id="product-form">
        <label>Código del producto: <input type="text" id="code" required></label>
        <label>Marca: <input type="text" id="brand" required></label>
        <label>Código marca: <input type="text" id="brand_code" required></label>
        <label>Nombre: <input type="text" id="name" required></label>
        <label>Precio: <input type="number" step="0.01" id="price" required></label>
        <button type="submit" id="submit-btn">Agregar Producto</button>
        <button type="button" id="cancel-btn" style="display:none;">Cancelar Edición</button>
    </form>

    <h2>Movimientos de Inventario</h2>
    <form id="movement-form">
        <label>Producto:
            <select id="product-select"></select>
        </label>
        <label>Tipo de movimiento:
            <select id="movement-type">
                <option value="IN">Entrada</option>
                <option value="OUT">Salida</option>
            </select>
        </label>
        <label>Cantidad: <input type="number" id="movement-quantity" min="1" required></label>
        <label>Descripción: <input type="text" id="movement-description"></label>
        <button type="submit">Registrar Movimiento</button>
    </form>

    <div id="movement-list"></div>

<!-- CSRF Helper Script -->
<script>
// Función para obtener el token CSRF de las cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');
</script>

<script>
const apiUrl = '/api/products/';
const movementApiUrl = '/api/inventory-movements/';

async function fetchProducts() {
    const res = await fetch(apiUrl);
    const data = await res.json();
    const container = document.getElementById('product-list');
    const select = document.getElementById('product-select');
    container.innerHTML = '';
    select.innerHTML = '<option value="">-- Selecciona producto --</option>';
    data.forEach(product => {
        let prices = product.Precio.map(p => p.Valor).join(', ');
        container.innerHTML += `
            <div>
                <strong>${product.Código_del_producto}</strong> - ${product.Nombre} - ${product.Marca} - Precios: ${prices}
                <button onclick="startEdit('${product.Código_del_producto}')">Editar</button>
                <button onclick="deleteProduct('${product.Código_del_producto}')">Eliminar</button>
            </div>
        `;
        select.innerHTML += `<option value="${product.id}">${product.Código_del_producto} - ${product.Nombre}</option>`;
    });
}

async function fetchMovements() {
    const res = await fetch(movementApiUrl);
    const data = await res.json();
    const container = document.getElementById('movement-list');
    container.innerHTML = '<h3>Historial de movimientos</h3>';
    data.forEach(m => {
        container.innerHTML += `
            <div>
                Producto ID: ${m.product} - Tipo: ${m.movement_type_display} - Cantidad: ${m.quantity} - Fecha: ${new Date(m.date).toLocaleString()} - ${m.description || ''}
            </div>
        `;
    });
}

async function deleteProduct(code) {
    if (!confirm('¿Seguro quieres eliminar este producto?')) return;
    const res = await fetch(apiUrl + code + '/', {
        method: 'DELETE',
        headers: { 'X-CSRFToken': csrftoken }
    });
    if (res.ok) {
        alert('Producto eliminado');
        fetchProducts();
        fetchMovements();
    } else {
        alert('Error al eliminar producto');
    }
}

function startEdit(code) {
    fetch(apiUrl + code + '/')
        .then(res => res.json())
        .then(product => {
            document.getElementById('code').value = product.Código_del_producto;
            document.getElementById('brand').value = product.Marca;
            document.getElementById('brand_code').value = product.Código;
            document.getElementById('name').value = product.Nombre;
            document.getElementById('price').value = product.Precio[0]?.Valor || '';
            document.getElementById('code').disabled = true;
            document.getElementById('submit-btn').textContent = 'Actualizar Producto';
            document.getElementById('cancel-btn').style.display = 'inline-block';
            document.getElementById('product-form').dataset.editing = code;
        });
}

document.getElementById('cancel-btn').addEventListener('click', () => {
    document.getElementById('product-form').reset();
    document.getElementById('code').disabled = false;
    document.getElementById('submit-btn').textContent = 'Agregar Producto';
    document.getElementById('cancel-btn').style.display = 'none';
    delete document.getElementById('product-form').dataset.editing;
});

document.getElementById('product-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const code = document.getElementById('code').value;
    const brand = document.getElementById('brand').value;
    const brand_code = document.getElementById('brand_code').value;
    const name = document.getElementById('name').value;
    const price = parseFloat(document.getElementById('price').value);

    const productData = {
        "Código_del_producto": code,
        "Marca": brand,
        "Código": brand_code,
        "Nombre": name,
        "Precio": [{ "Valor": price }]
    };

    const isEditing = e.target.dataset.editing;

    let url = apiUrl;
    let method = 'POST';

    if (isEditing) {
        url += isEditing + '/';
        method = 'PUT';
    }

    const res = await fetch(url, {
        method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(productData)
    });

    if (res.ok) {
        fetchProducts();
        fetchMovements();
        e.target.reset();
        document.getElementById('code').disabled = false;
        document.getElementById('submit-btn').textContent = 'Agregar Producto';
        document.getElementById('cancel-btn').style.display = 'none';
        delete e.target.dataset.editing;
    } else {
        alert('Error al guardar producto');
    }
});

document.getElementById('movement-form').addEventListener('submit', async e => {
    e.preventDefault();
    const product = document.getElementById('product-select').value;
    const movement_type = document.getElementById('movement-type').value;
    const quantity = parseInt(document.getElementById('movement-quantity').value);
    const description = document.getElementById('movement-description').value;

    if (!product) {
        alert('Selecciona un producto');
        return;
    }
    if (quantity <= 0) {
        alert('Cantidad debe ser mayor a 0');
        return;
    }

    const movementData = {
        product,
        movement_type,
        quantity,
        description
    };

    const res = await fetch(movementApiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(movementData)
    });

    if (res.ok) {
        alert('Movimiento registrado');
        fetchProducts();
        fetchMovements();
        e.target.reset();
    } else {
        const err = await res.json();
        alert('Error al registrar movimiento: ' + JSON.stringify(err));
    }
});

fetchProducts();
fetchMovements();
</script>
</body>
</html>




