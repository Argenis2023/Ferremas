<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Inventario de Productos</title>
</head>
<body>
    <h1>Inventario de Productos</h1>

    <div id="product-list"></div>

    <h2>Agregar / Editar Producto</h2>
    <form id="product-form">
        <label>Código del producto: <input type="text" id="code" required></label><br>
        <label>Marca: <input type="text" id="brand" required></label><br>
        <label>Código marca: <input type="text" id="brand_code" required></label><br>
        <label>Nombre: <input type="text" id="name" required></label><br>
        <label>Precio: <input type="number" step="0.01" id="price" required></label><br>
        <button type="submit" id="submit-btn">Agregar Producto</button>
        <button type="button" id="cancel-btn" style="display:none;">Cancelar Edición</button>
    </form>

<script>
const apiUrl = '/api/products/';

// Cargar y mostrar productos
async function fetchProducts() {
  const res = await fetch(apiUrl);
  const data = await res.json();
  const container = document.getElementById('product-list');
  container.innerHTML = '';
  data.forEach(product => {
    let prices = product.Precio.map(p => p.Valor).join(', ');
    container.innerHTML += `
      <div>
        <strong>${product.Código_del_producto}</strong> - ${product.Nombre} - ${product.Marca} - Precios: ${prices}
        <button onclick="startEdit(${product.id})">Editar</button>
        <button onclick="deleteProduct(${product.id})">Eliminar</button>
      </div>
    `;
  });
}

// Eliminar producto por id
async function deleteProduct(id) {
  if (!confirm('¿Seguro quieres eliminar este producto?')) return;
  const res = await fetch(apiUrl + id + '/', { method: 'DELETE' });
  if (res.ok) {
    alert('Producto eliminado');
    fetchProducts();
  } else {
    alert('Error al eliminar producto');
  }
}

// Iniciar edición, carga datos en formulario
function startEdit(id) {
  fetch(apiUrl + id + '/')
    .then(res => res.json())
    .then(product => {
      document.getElementById('code').value = product.Código_del_producto;
      document.getElementById('brand').value = product.Marca;
      document.getElementById('brand_code').value = product.Código;
      document.getElementById('name').value = product.Nombre;
      document.getElementById('price').value = product.Precio[0]?.Valor || '';
      document.getElementById('code').disabled = true;
      document.getElementById('submit-btn').textContent = 'Actualizar Producto';
      document.getElementById('cancel-btn').style.display = 'inline-block';
      document.getElementById('product-form').dataset.editing = id;
    });
}

// Cancelar edición
document.getElementById('cancel-btn').addEventListener('click', () => {
  document.getElementById('product-form').reset();
  document.getElementById('code').disabled = false;
  document.getElementById('submit-btn').textContent = 'Agregar Producto';
  document.getElementById('cancel-btn').style.display = 'none';
  delete document.getElementById('product-form').dataset.editing;
});

// Crear o actualizar producto
document.getElementById('product-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const code = document.getElementById('code').value;
  const brand = document.getElementById('brand').value;
  const brand_code = document.getElementById('brand_code').value;
  const name = document.getElementById('name').value;
  const price = parseFloat(document.getElementById('price').value);

  const productData = {
    "Código_del_producto": code,
    "Marca": brand,
    "Código": brand_code,
    "Nombre": name,
    "Precio": [{ "Valor": price }]
  };

  const isEditing = e.target.dataset.editing;

  let url = apiUrl;
  let method = 'POST';

  if (isEditing) {
    url += isEditing + '/';
    method = 'PUT';
  }

  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(productData)
  });

  if (res.ok) {
    fetchProducts();
    e.target.reset();
    document.getElementById('code').disabled = false;
    document.getElementById('submit-btn').textContent = 'Agregar Producto';
    document.getElementById('cancel-btn').style.display = 'none';
    delete e.target.dataset.editing;
  } else {
    alert('Error al guardar producto');
  }
});

// Carga inicial
fetchProducts();
</script>
</body>
</html>
